{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}Compliance – Admin Upload{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 class="mb-0">Compliance Documents (Admin)</h2>
      <div class="text-muted small">Upload for users and set expiry/status.</div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-white border-0">
      <strong>Upload a Document</strong>
    </div>
    <div class="card-body">
      <form method="post" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}
        <div class="col-12 col-md-4">
          <label class="form-label">User</label>
          {% render_field form.user class+="form-select" %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Type</label>
          {% render_field form.doc_type class+="form-select" %}
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">File</label>
          {% render_field form.file class+="form-control" %}
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Issue date</label>
          {% render_field form.issue_date class+="form-control" %}
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Expiry date</label>
          {% render_field form.expiry_date class+="form-control" %}
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">Status</label>
          {% render_field form.status class+="form-select" %}
        </div>
        <div class="col-12">
          <label class="form-label">Notes</label>
          {% render_field form.notes class+="form-control" %}
        </div>
        <div class="col-12 d-flex justify-content-end">
          <button class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-12 col-md-3">
      <label class="form-label">Search</label>
      <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="user/type…">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">User</label>
      <select name="user" class="form-select">
        <option value="">Any</option>
        {% for u in users %}
          <option value="{{ u.id }}" {% if user_filter == u.id|stringformat:"s" %}selected{% endif %}>
            {{ u.get_full_name|default:u.username }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label">Type</label>
      <select name="type" class="form-select">
        <option value="">Any</option>
        {% for t in types %}
          <option value="{{ t.id }}" {% if type_filter == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="">Any</option>
        <option value="approved" {% if status_filter == "approved" %}selected{% endif %}>Approved</option>
        <option value="pending" {% if status_filter == "pending" %}selected{% endif %}>Pending</option>
        <option value="rejected" {% if status_filter == "rejected" %}selected{% endif %}>Rejected</option>
      </select>
    </div>
    <div class="col-6 col-md-1">
      <button class="btn btn-outline-secondary w-100">Filter</button>
    </div>
  </form>

  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>Type</th>
            <th>Issued</th>
            <th>Expiry</th>
            <th>Status</th>
            <th>Notes</th>
            <th class="text-end">File</th>
          </tr>
        </thead>
        <tbody>
          {% for d in docs %}
            <tr>
              <td class="small">{{ d.user.get_full_name|default:d.user.username }}</td>
              <td>{{ d.doc_type.name }}</td>
              <td class="text-nowrap">{{ d.issue_date|date:"j M Y"|default:"—" }}</td>
              <td class="text-nowrap">
                {% if d.expiry_date %}
                  {{ d.expiry_date|date:"j M Y" }}
                  {% if d.is_expired %}
                    <span class="badge text-bg-danger ms-1">Expired</span>
                  {% elif d.days_left <= 30 %}
                    <span class="badge text-bg-warning text-dark ms-1">Expiring ({{ d.days_left }}d)</span>
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td>
                {% if d.status == "approved" %}
                  <span class="badge text-bg-success">Approved</span>
                {% elif d.status == "pending" %}
                  <span class="badge text-bg-secondary">Pending</span>
                {% else %}
                  <span class="badge text-bg-danger">Rejected</span>
                {% endif %}
              </td>
              <td class="small text-truncate" style="max-width: 260px;">{{ d.notes|default:"" }}</td>
              <td class="text-end">
                {% if d.file %}<a class="btn btn-sm btn-outline-secondary" href="{{ d.file.url }}">View</a>{% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7" class="text-muted">No documents.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
